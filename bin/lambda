#!/bin/bash

# lambda path
route=$HOME/Lambda
# memory path
memory=$route/memory
# log file
log_file=$memory/log.txt

# colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No color

case $1 in

	run)
		echo -e "${GREEN}Running Lambda λ${NC}"
		# append to log
		echo "[BIN] -> running lambda at $(date +"[%Y-%m-%d - %T]")" >> $log_file
		# run lambda appas
		tmux new-session -d -s lambda "cd $route && python3 lambda/app.py"
		# run the interfaces
		tmux new-session -d -s discordo "cd $route && python3 interfaces/discordo.py"
		# sleep and wait to errors
        sleep 1
        # see tmux active sessions
        tmux ls
	;;

	kill)
		echo -e "${RED}Killing Lambda λ${NC}"
		# append to log
		echo "[BIN] -> killing lambda at $(date +"[%Y-%m-%d - %T]")" >> $log_file
		# kill lambda
		tmux kill-session -t lambda
		tmux kill-session -t discordo
	;;

	update)
		cd $route
		echo -e "${BLUE}Updating Lambda λ${NC}"
		# append to log
		echo "[BIN] -> updating lambda at $(date +"[%Y-%m-%d - %T]")" >> $log_file
		# update lambda
		git fetch && git merge origin/main
	;;

	reboot)
		echo -e "${GREEN}Rebooting Lambda λ${NC}"
		# append to log
		echo "[BIN] -> rebooting lambda at $(date +"[%Y-%m-%d - %T]")" >> $log_file
		# kill lambda
		tmux kill-session -t lambda
	    tmux kill-session -t discordo
	    # and run lambda again
		tmux new-session -d -s lambda "cd $route && python3 lambda/app.py"
        tmux new-session -d -s discordo "cd $route && python3 interfaces/discordo.py"
        # sleep and wait to errors
        sleep 1
        # see tmux active sessions
        tmux ls
	;;

	rupdate)
		cd $route
		echo -e "${GREEN}Rupdating Lambda λ${NC}"
		# append to log
		echo "[BIN] -> rupdating lambda at $(date +"[%Y-%m-%d - %T]")" >> $log_file
		# kill lambda
		tmux kill-session -t lambda
		tmux kill-session -t discordo
		# update lambda
		git fetch && git merge origin/main
		# run lambda again
		tmux new-session -d -s lambda "cd $route && python3 lambda/app.py"
		tmux new-session -d -s discordo "cd $route && python3 interfaces/discordo.py"
		# sleep and wait to errors
        sleep 1
        # see tmux active sessions
        tmux ls
	;;

	# backup from all the memory files. located in ram and data
	backup)
		cd $route
		echo -e "${BLUE}Making Lambda Backup λ${NC}"
		# append to log
		echo "[BIN] -> lambda backup at $(date +"[%Y-%m-%d - %T]")" >> $log_file
		# date label to name the file
		date=$(date +%m-%d-%Y)
		# get the last lines of the log
		last_log=$(tail $log_file)
		# create the folder for the files called backup
		mkdir backup
		# copy the important files to the folder
		cp -r memory backup
		# make the memory backup and send it to backups
		tar -cvf backups/$date-backup.tar.gz backup
		# remove the backup file
		rm -rf backup
		# and clear the log file, only keep the last lines
		echo "$last_log" > $log_file
	;;

	# load a backup from a certain file
	checkpoint)
		# first make a backup from the actual memory
		lambda backup
		# remove the memory dir
		rm -rf $memory
		# unzip the backup, a backup folder will be created
		tar -xvf $2
		# move the memory dir to Lambda
		mv backup/memory $route
		# and delete the backup unziped backup
		rm -rf backup
		echo -e "${BLUE}Lambda Checpoint Saved λ${NC}"
		# finally move the checkpoint to backups
		mv $2 $route/backups
		# and add this to the log
		echo "[BIN] -> lambda checkpoint at $(date +"[%Y-%m-%d - %T]")" >> $log_file
	;;

	# run an app
	app)
		cd $route
		# locate the app
		app="apps/$2/$2"
		echo $app
		# and run the app
		tmux new-session -d -s $2 "sh $app"
		# append to log
		echo "[BIN] -> lambda app $2 ran at $(date +"[%Y-%m-%d - %T]")" >> $log_file
	;;

	# kill app
	app-kill)
		# kill the app session
		tmux kill-session -t $2
		# append to log
		echo "[BIN] -> lambda app $2 killed at $(date +"[%Y-%m-%d - %T]")" >> $log_file
	;;

	*)
		echo Unknown Command λ
		echo lambda "[run|kill|update|reboot|rupdate|backup|checkpoint|app|app-kill]"
	;;
esac